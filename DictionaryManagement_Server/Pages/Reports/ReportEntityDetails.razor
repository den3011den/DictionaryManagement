@page "/reports/ReportTemplate/ReportEntityDetailes/{ReportEntityId}"
@attribute [Authorize]

@using DictionaryManagement_Business.Repository.IRepository;
@using DictionaryManagement_Models.IntDBModels

@inject IJSRuntime _jsRuntime

@inject IReportEntityRepository _reportEntityRepository
@inject IReportEntityLogRepository _reportReportEntityLogRepository
@inject ISettingsRepository _settingsRepository

@inject DialogService _dialogService


@if (IsAdmin == true)
{
    <_Dialogs @ref="_dialogs"></_Dialogs>


    @if (IsLoading)
    {
        <div class="text-center">
            <img src="/images/loading.gif">
        </div>
    }
    else
    {

        <RadzenTabs @bind-SelectedIndex=@selectedTabIndex>

            <Tabs>
                <RadzenTabsItem Text="Детали">

                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="12" SizeMD="5">
                            <RadzenStack>
                                <RadzenFieldset Text="Данные экземпляра отчёта" Style="font-weight: bold;">
                                    <RadzenStack Gap="1rem">
                                        <RadzenFormField Text="ИД экземпляра отчёта" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                            <RadzenTextBox Value="@ActiveReportEntityDTO.Id.ToString()" ReadOnly="true" />
                                        </RadzenFormField>

                                        <RadzenFormField Text="Данные в отчёте с даты" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                            <RadzenDatePicker ShowTime="false" ShowSeconds="false" DateFormat="dd.MM.yyyy" @bind-Value="@ActiveReportEntityDTO.ReportTimeStart" ReadOnly="true" />
                                        </RadzenFormField>

                                        <RadzenFormField Text="Данные в отчёте по дату" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                            <RadzenDatePicker ShowTime="false" ShowSeconds="false" DateFormat="dd.MM.yyyy" @bind-Value="@ActiveReportEntityDTO.ReportTimeEnd" ReadOnly="true" />
                                        </RadzenFormField>

                                         <RadzenFormField Text="Производство" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                            <RadzenTextArea @bind-Value="@ActiveReportEntityDTO.ReportDepartmentDTOFK.ShortName" ReadOnly="true" />
                                         </RadzenFormField>

                                     </RadzenStack>
                                 </RadzenFieldset>
                             </RadzenStack>
                             <RadzenStack>
                                 <RadzenFieldset Text="Информация о скачивании отчёта" Style="font-weight: bold;">
                                     <RadzenStack Gap="1rem">
                                         <RadzenFormField Text="Время скачивания файла" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                             <RadzenDatePicker ShowTime="true" ShowSeconds="true" DateFormat="dd.MM.yyyy hh:mm:ss" @bind-Value="@ActiveReportEntityDTO.DownloadTime" ReadOnly="true" />
                                         </RadzenFormField>

                                         <RadzenFormField Text="Кто скачивал файл" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                             <RadzenTextBox @bind-Value="@ActiveReportEntityDTO.DownloadUserDTOFK.UserName" ReadOnly="true" />
                                         </RadzenFormField>

                                         <div class="rz-text-align-left">
                                             <RadzenCheckBox Disabled="true" @bind-Value=@ActiveReportEntityDTO.DownloadSuccessFlag Name="CheckBox31" />
                                             <RadzenLabel Style="font-weight: normal;" Text="Успех скачивания файла пользователем" Component="CheckBox3" />
                                         </div>

                                         <div class="rz-text-align-left">
                                             <RadzenButton title="Скачать файл" Icon="download" Disabled="@(String.IsNullOrEmpty(fileDownloadFullPath))" ButtonStyle="ButtonStyle.Light " Style="margin-top: 10px;" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@(args => DownloadReportEntityDownloadFile(@ActiveReportEntityDTO.Id))" @onclick:stopPropagation="true">
                                             </RadzenButton>
                                             <RadzenFormField Text="Скачанный файл на сервере" Variant="@variant" Style="width: 92%; max-width: 900px;">
                                                 <RadzenTextBox @bind-Value="@fileDownloadFullPath" ReadOnly />
                                             </RadzenFormField>
                                         </div>

                                     </RadzenStack>
                                 </RadzenFieldset>
                             </RadzenStack>
                         </RadzenColumn>

                         <RadzenColumn Size="12" SizeMD="5">

                             <RadzenStack>
                                 <RadzenFieldset Text="Информация о шаблоне отчёта" Style="font-weight: bold;">
                                     <RadzenStack Gap="1rem">


                                         <RadzenFormField Text="ИД шаблона отчёта" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                             <RadzenTextBox Value="@ActiveReportEntityDTO.ReportTemplateId.ToString()" ReadOnly="true" />
                                         </RadzenFormField>

                                         <RadzenFormField Text="Тип шаблона отчёта" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                             <RadzenTextBox Value="@ActiveReportEntityDTO.ReportTemplateDTOFK.ReportTemplateTypeDTOFK.Name" ReadOnly="true" />
                                         </RadzenFormField>

                                         <RadzenFormField Text="Производство" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                             <RadzenTextBox Value="@ActiveReportEntityDTO.ReportTemplateDTOFK.MesDepartmentDTOFK.ShortName" ReadOnly="true" />
                                         </RadzenFormField>

                                         <RadzenFormField Text="Наименование шаблона отчёта" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                             <RadzenTextArea Value="@ActiveReportEntityDTO.ReportTemplateDTOFK.Description" ReadOnly="true" />
                                         </RadzenFormField>

                                     </RadzenStack>
                                 </RadzenFieldset>
                             </RadzenStack>


                             <RadzenStack>
                                 <RadzenFieldset Text="Информация о загрузке отчёта" Style="font-weight: bold;">
                                     <RadzenStack Gap="1rem">
                                         <RadzenFormField Text="Время загрузки файла" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                             <RadzenDatePicker ShowTime="true" ShowSeconds="true" DateFormat="dd.MM.yyyy hh:mm:ss" @bind-Value="@ActiveReportEntityDTO.UploadTime" ReadOnly="true" />
                                         </RadzenFormField>

                                         @if (ActiveReportEntityDTO.UploadUserDTOFK != null)
                                        {
                                            <RadzenFormField Text="Кто загружал файл" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                                <RadzenTextBox @bind-Value="@ActiveReportEntityDTO.UploadUserDTOFK.UserName"
                                                                      ReadOnly />
                                             </RadzenFormField>
                                        }
                                        else
                                        {
                                            <RadzenFormField Text="Кто загружал файл" Variant="@variant" Style="width: 100%; max-width: 940px;">
                                                <RadzenTextBox ReadOnly />
                                             </RadzenFormField>
                                        }

                                        <div class="rz-text-align-left">
                                            <RadzenCheckBox Disabled="true" @bind-Value=@ActiveReportEntityDTO.UploadSuccessFlag Name="CheckBox41" />
                                            <RadzenLabel Text="Успех загрузки файла пользователем" Component="CheckBox4" Style="margin-left: 1px; font-weight: normal;" />
                                        </div>

                                        <div class="rz-text-align-left">
                                            <RadzenButton title="Скачать файл" Icon="download" Disabled="@(String.IsNullOrEmpty(fileUploadFullPath))" ButtonStyle="ButtonStyle.Light" Style="margin-top: 10px;" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@(args => DownloadReportEntityUploadFile(@ActiveReportEntityDTO.Id))" @onclick:stopPropagation="true">
                                            </RadzenButton>

                                            <RadzenFormField Text="Загруженный файл на сервере" Variant="@variant" Style="width: 92%; max-width: 900px;">
                                                <RadzenTextBox @bind-Value="@fileUploadFullPath"
                                                                          ReadOnly />
                                             </RadzenFormField>
                                         </div>
                                     </RadzenStack>
                                 </RadzenFieldset>
                             </RadzenStack>

                             @* <RadzenStack>
                    <RadzenFieldset Text="События экземпляра отчёта">
                    <RadzenStack Gap="1rem">


                    <RadzenDataGridApp AllowAlternatingRows="true" AllowFiltering="true" PageSize="5" AllowPaging="true" AllowSorting="true" AllowMultiColumnSorting="true" EditMode="DataGridEditMode.Single"
                    Data="reportEntityLogDTOs" TItem="ReportEntityLogDTO"
                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                    FilterMode="FilterMode.Simple"
                    Density=Density.Compact
                    ShowPagingSummary="true"
                    EmptyText="Нет записей для отображения"
                    AllowVirtualization="true">
                    <Columns>
                    <RadzenDataGridColumn TItem="ReportEntityLogDTO" Property="Id" Title="Ид записи" Width="30px">
                    </RadzenDataGridColumn>


                    <RadzenDataGridColumn TItem="ReportEntityLogDTO" Property="LogTime" Title="Время события" Width="60px">
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="ReportEntityLogDTO" Property="LogType" Title="Тип" Width="55px">
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="ReportEntityLogDTO" Property="LogMessage" Title="Событие" Width="150px" FilterProperty="LogMessage" SortProperty="LogMessage">
                    <Template Context="data1">
                    <RadzenCard Style="white-space:pre-wrap">
                    <RadzenText TextStyle="TextStyle.Body2">
                    <strong>
                    @data1.LogMessage
                    </strong>
                    </RadzenText>
                    </RadzenCard>
                    </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="ReportEntityLogDTO" Property="IsError" Title="Ошибка" Filterable="true" Width="30px">
                    <Template Context="data">
                    <RadzenCheckBox @bind-Value=data.IsError Disabled="true" TriState="false" TValue="bool" />
                    </Template>
                    </RadzenDataGridColumn>
                    </Columns>
                    </RadzenDataGridApp>
                    </RadzenStack>
                    </RadzenFieldset>
                    </RadzenStack>*@
                         </RadzenColumn>
                     </RadzenRow>
                 </RadzenTabsItem>

                 <RadzenTabsItem Text="Данные в Архиве данных">
                     Данные в Архиве данных
                 </RadzenTabsItem>
                 <RadzenTabsItem Text="Входные данные (InputData)">
                     InputData
                 </RadzenTabsItem>
                 <RadzenTabsItem Text="Тэги (TagList)">
                     TagList
                 </RadzenTabsItem>
                 <RadzenTabsItem Text="Входные данные (OutputData)">
                     OutputData
                 </RadzenTabsItem>
                 <RadzenTabsItem Text="Журнал событий (LogEvent)">
                     OutputData
                 </RadzenTabsItem>
             </Tabs>

         </RadzenTabs>

        @*    <div class="form-group py-2">
        <NavLink @onclick="(() => ReportEntityDetailesClose())" class="btn btn-primary">OK</NavLink>
    </div>*@

        @*  </EditForm> *@
    }
}


@code {

    [CascadingParameter]
    bool iconMenuActive { get; set; }

    int selectedTabIndex = 0;

    _Dialogs? _dialogs { get; set; }

    IEnumerable<ReportEntityLogDTO>? reportEntityLogDTOs;

    [Parameter]
    public Guid ReportEntityId { get; set; }

    Variant variant = Variant.Outlined;

    public string reportDownloadPath = "";
    public string reportUploadPath = "";
    public string fileDownloadFullPath = "";
    public string fileUploadFullPath = "";

    public bool IsLoading { get; set; }
    public bool IsAdmin { get; set; }

    public ReportEntityDTO? ActiveReportEntityDTO { get; set; }

    private string Title { get; set; } = "Данные экземпляра отчёта";


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (await _authorizationRepository.CurrentUserIsInAdminRole(SD.MessageBoxMode.On))
        {
            IsLoading = true;
            StateHasChanged();

            ActiveReportEntityDTO = await _reportEntityRepository.GetById(ReportEntityId);
            reportEntityLogDTOs = await _reportReportEntityLogRepository.GetByReportEntityId(ReportEntityId);
            if (reportEntityLogDTOs == null)
            {
                reportEntityLogDTOs = new List<ReportEntityLogDTO>();
            }
            reportUploadPath = (await _settingsRepository.GetByName("ReportUploadPath")).Value;
            if (String.IsNullOrEmpty(ActiveReportEntityDTO.UploadReportFileName))
                fileUploadFullPath = "";
            else
                fileUploadFullPath = reportUploadPath + ActiveReportEntityDTO.UploadReportFileName;
            reportDownloadPath = (await _settingsRepository.GetByName("ReportDownloadPath")).Value;
            if (String.IsNullOrEmpty(ActiveReportEntityDTO.DownloadReportFileName))
                fileDownloadFullPath = "";
            else
                fileDownloadFullPath = reportDownloadPath + ActiveReportEntityDTO.DownloadReportFileName;

            IsLoading = false;
            IsAdmin = true;
            StateHasChanged();

        }
    }

    private async Task ReportEntityDetailesClose()
    {
        _dialogService.Close(null);
    }

    async Task DownloadReportEntityDownloadFile(Guid id)
    {
        if (await _authorizationRepository.CurrentUserIsInAdminRole(SD.MessageBoxMode.On))
        {
            IsAdmin = true;
            await _jsRuntime.InvokeVoidAsync("open", "/DownloadFileController/DownloadReportEntityDownloadFile/" + id.ToString(), "_blank");
        }
    }

    async Task DownloadReportEntityUploadFile(Guid id)
    {
        if (await _authorizationRepository.CurrentUserIsInAdminRole(SD.MessageBoxMode.On))
        {
            IsAdmin = true;
            await _jsRuntime.InvokeVoidAsync("open", "/DownloadFileController/DownloadReportEntityUploadFile/" + id.ToString(), "_blank");
        }
    }
}
