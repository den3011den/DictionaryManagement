@page "/administration/MesDepartment"
@attribute [Authorize]

@using DictionaryManagement_Business.Repository.IRepository;
@using DictionaryManagement_Common;
@using DictionaryManagement_DataAccess.Data.IntDB;
@using DictionaryManagement_Models.IntDBModels
@using Microsoft.EntityFrameworkCore;
@using System.Text.Json;


@inject IJSRuntime _jsRuntime
@inject IMesDepartmentRepository _mesDepartmentRepository

@inject DialogService _dialogService

@*<head>    
    <style type="text/css">
        .rz-celldata td {
            padding: 0px;
        }
    </style>
</head>*@


<_Dialogs @ref="_dialogs"></_Dialogs>

<div class="row">

    <div class="col-6">
        <h4 class="card-title text-primary"><a href="/administration">Администрирование</a> - <a href="/administration/MesDepartment">Производства</a></h4>
    </div>

    @if (IsLoading != true)
    {

        <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="add_circle_outline" class="mt-2 mb-4" Text="Добавить новое производство" Click="@(args => EditRow(null))" />
        <RadzenDataGrid @bind-Settings="@MesDepartmentGridSettings" @ref="mesDepartmentDTOGrid" AllowColumnResize="true" ExpandMode="DataGridExpandMode.Single"
                        Data="@mesDepartmentDTOs" TItem="MesDepartmentDTO" RowRender="@RowRender" LoadChildData="@LoadChildData"
                        AllowFiltering="true" AllowPaging="false" AllowSorting="true" AllowMultiColumnSorting="true"
                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        FilterMode="FilterMode.Simple"
                        Density="Density.Compact"
                        Style="height:780px">
            <Columns>
                <RadzenDataGridColumn TItem="MesDepartmentDTO" Title="Наименование" Frozen="true" Width="340px">
                    <Template Context="data">

                        <strong>@data.Name</strong>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="MesDepartmentDTO" Property="Id" Title="ИД" Width="60px" FilterOperator="FilterOperator.Contains" />
                <RadzenDataGridColumn TItem="MesDepartmentDTO" Property="MesCode" Title="Код" Width="100px" FilterOperator="FilterOperator.Contains" />
                <RadzenDataGridColumn TItem="MesDepartmentDTO" Property="ShortName" Title="Сокр. наименование" Width="340px" FilterOperator="FilterOperator.Contains" />

                <RadzenDataGridColumn TItem="MesDepartmentDTO" Property="IsArchive" Title="Архив" Filterable="true" Width="40px">
                    <Template Context="data">
                        <RadzenCheckBox @bind-Value="data.IsArchive" ReadOnly="true" TriState="false" TValue="bool" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="MesDepartmentDTO" Context="mesDepartmentDTO" Filterable="true" Sortable="false" TextAlign="TextAlign.Right" Width="70px">
                    <Template Context="mesDepartmentDTO">
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@(args => EditRow(mesDepartmentDTO))" @onclick:stopPropagation="true">
                        </RadzenButton>
                        @if (!mesDepartmentDTO.IsArchive)
                        {
                            <RadzenButton Tooltip="Восстановить из архива" ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter" Size="ButtonSize.Medium" class="my-1 ms-1" Click="@(args => DeleteRow(mesDepartmentDTO))" @onclick:stopPropagation="true">
                            </RadzenButton>
                        }
                        else
                        {
                            <RadzenButton ButtonStyle="ButtonStyle.Info" Icon="restore_from_trash" Variant="Variant.Flat" Shade="Shade.Lighter" Size="ButtonSize.Medium" class="my-1 ms-1" Click="@(args => DeleteRow(mesDepartmentDTO))" @onclick:stopPropagation="true">
                            </RadzenButton>
                        }

                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>

    }
    else
    {
        if (IsLoading)
        {
            //отображение gif загрузки
            <div class="text-center">
                <img src="/images/loading.gif">
            </div>

        }
    }

</div>

<css>

</css>

@code {

    _Dialogs? _dialogs { get; set; }

    IEnumerable<MesDepartmentDTO>? mesDepartmentDTOs;

    RadzenDataGrid<MesDepartmentDTO> mesDepartmentDTOGrid;

    public bool IsLoading { get; set; }


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {
            IsLoading = true;
            await LoadStateAsync();
            StateHasChanged();
            mesDepartmentDTOs = await _mesDepartmentRepository.GetAllTopLevel();
            IsLoading = false;
            StateHasChanged();
        }
        else
        {
            //var ffffff = 1;
        }
    }

    DataGridSettings _mesDepartmentGridSettings;
    public DataGridSettings MesDepartmentGridSettings
    {
        get
        {
            return _mesDepartmentGridSettings;
        }
        set
        {
            if (_mesDepartmentGridSettings != value)
            {
                _mesDepartmentGridSettings = value;
                InvokeAsync(SaveStateAsync);
            }
        }
    }

    private async Task LoadStateAsync()
    {
        await Task.CompletedTask;

        var result = await _jsRuntime.InvokeAsync<string>("window.localStorage.getItem", "MesDepartmentGridSettings");
        if (!string.IsNullOrEmpty(result))
        {
            _mesDepartmentGridSettings = JsonSerializer.Deserialize<DataGridSettings>(result);
        }
    }

    private async Task SaveStateAsync()
    {
        await Task.CompletedTask;

        await _jsRuntime.InvokeVoidAsync("eval", $@"window.localStorage.setItem('MesDepartmentGridSettings', '{JsonSerializer.Serialize<DataGridSettings>(MesDepartmentGridSettings)}')");
        //var gggg = 2;
    }


    void RowRender(RowRenderEventArgs<MesDepartmentDTO> args)
    {
        args.Expandable = _mesDepartmentRepository.HasChild(args.Data.Id).GetAwaiter().GetResult();        
    }

    void LoadChildData(DataGridLoadChildDataEventArgs<MesDepartmentDTO> args)
    {
        args.Data = _mesDepartmentRepository.GetChildList(args.Item.Id).GetAwaiter().GetResult();
    }

    async Task EditRow(MesDepartmentDTO mesDepartmentDTO)
    {
        MesDepartmentDTO dialogResult;

        if (mesDepartmentDTO == null)
        {

            dialogResult = await _dialogService.OpenAsync<AddEditMesDepartment>("Создать производство", new Dictionary<string, object>() { { "MesDepartmentId", 0 } });
        }
        else
        {
            dialogResult = await _dialogService.OpenAsync<AddEditMesDepartment>("Изменить производство", new Dictionary<string, object>() { { "MesDepartmentId", mesDepartmentDTO.Id } });
        }


        if (dialogResult != null)
        {

            IsLoading = true;
            await LoadStateAsync();
            StateHasChanged();
            mesDepartmentDTOs = await _mesDepartmentRepository.GetAllTopLevel();
            IsLoading = false;
            StateHasChanged();
        }
    }


    async Task DeleteRow(MesDepartmentDTO mesDepartmentDTO)
    {

        if (_dialogs != null)
        {
            if (mesDepartmentDTO.IsArchive != true)
            {
                bool selectionResult = await _dialogs.ShowYesOrNoDialogBox("Удаление производства", "Удалить производство \"" + mesDepartmentDTO.ShortName + "\" в архив ?", "Удалить", "Отмена");
                if (selectionResult == false)
                {
                    await _jsRuntime.ToastrSuccess("Отмена удаления");
                    return;
                }
            }
            else
            {
                bool selectionResult = await _dialogs.ShowYesOrNoDialogBox("Восстановление производства", "Восстановить производство \"" + mesDepartmentDTO.ShortName + "\" из архива ?", "Восстановить", "Отмена");
                if (selectionResult == false)
                {
                    await _jsRuntime.ToastrSuccess("Отмена восстановления");
                    return;
                }
            }
        }



        //if (mesDepartmentDTOs.Contains(mesDepartmentDTO))
        //{
        if (mesDepartmentDTO.IsArchive)
        {
            await _mesDepartmentRepository.Delete(mesDepartmentDTO.Id, SD.UpdateMode.RestoreFromArchive);
            mesDepartmentDTO.IsArchive = false;
            await _jsRuntime.ToastrSuccess("Производство \"" + mesDepartmentDTO.Name + "\" восстановлено из архива");
        }
        else
        {
            await _mesDepartmentRepository.Delete(mesDepartmentDTO.Id, SD.UpdateMode.MoveToArchive);
            mesDepartmentDTO.IsArchive = true;
            await _jsRuntime.ToastrSuccess("Производство \"" + mesDepartmentDTO.Name + "\" удалёно в архив");
        }
        await mesDepartmentDTOGrid.UpdateRow(mesDepartmentDTO);
        //}
        //else
        //{
        //    mesDepartmentDTOGrid.CancelEditRow(mesDepartmentDTO);
        //    await mesDepartmentDTOGrid.Reload();
        //}
    }

}